/* AAP 2022 (SUPPLEMENTAL TABLE 4) - Exchange transfusion thresholds (mg/dL)
   Any hyperbilirubinemia neurotoxicity risk factor, by GA and age (hours).
   Data below is digitized/transcribed from the user's provided snippet for GA 35–40+ (>=38, 37, 36, 35). 
   Note: Only the provided snippet is included; treat as educational, verify against primary source before clinical use. */
(function(global){
  // Helper: flatten day/hour table into array indexed by hour since birth
  function toHourly(days){
    const out = [];
    for(let d=0; d<days.length; d++){
      const row = days[d];
      for(let h=0; h<row.length; h++){
        out.push({ x: d*24 + h, y: row[h] });
      }
    }
    return out;
  }

  // 38+ weeks ("Gestational age of 38 weeks or more and any risk factors")
  const GA_38P = toHourly([
    // Day 0 (24 values)
    [14.8,15.0,15.1,15.2,15.4,15.5,15.6,15.8,15.9,16.0,16.1,16.3,16.4,16.5,16.6,16.7,16.9,17.0,17.1,17.2,17.3,17.4,17.6,17.7],
    // Day 1
    [17.8,17.9,18.0,18.1,18.2,18.3,18.4,18.5,18.7,18.8,18.9,19.0,19.1,19.2,19.3,19.4,19.5,19.6,19.7,19.8,19.9,19.9,20.0,20.1],
    // Day 2
    [20.2,20.3,20.4,20.5,20.6,20.7,20.8,20.8,20.9,21.0,21.1,21.2,21.3,21.3,21.4,21.5,21.6,21.7,21.7,21.8,21.9,22.0,22.0,22.1],
    // Day 3
    [22.2,22.2,22.3,22.4,22.5,22.5,22.6,22.7,22.7,22.8,22.8,22.9,23.0,23.0,23.1,23.1,23.2,23.3,23.3,23.4,23.4,23.5,23.5,23.5],
    // Days 4–14 (flat 23.5)
    ...Array.from({length: 11}, () => Array(24).fill(23.5))
  ]);

  // 37 weeks
  const GA_37 = toHourly([
    [0.0, 14.3,14.4,14.6,14.7,14.8,15.0,15.1,15.2,15.4,15.5,15.6,15.7,15.9,16.0,16.1,16.2,16.4,16.5,16.6,16.7,16.8,17.0,17.1],
    [17.2,17.3,17.4,17.5,17.7,17.8,17.9,18.0,18.1,18.2,18.3,18.4,18.5,18.6,18.7,18.8,18.9,19.0,19.1,19.2,19.3,19.4,19.5,19.6],
    [19.7,19.8,19.9,20.0,20.1,20.1,20.2,20.3,20.4,20.5,20.6,20.7,20.7,20.8,20.9,21.0,21.1,21.1,21.2,21.3,21.4,21.4,21.5,21.6],
    [21.7,21.7,21.8,21.9,21.9,22.0,22.1,22.1,22.2,22.3,22.3,22.4,22.5,22.5,22.6,22.6,22.7,22.8,22.8,22.9,22.9,23.0,23.0,23.1],
    [23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.2],
    [23.2,23.2,23.2,23.2,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.4,23.4,23.4],
    [23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.5,23.5,23.5,23.5,23.5,23.5,23.5,23.5,23.5,23.5],
    ...Array.from({length: 8}, () => Array(24).fill(23.5))
  ]);

  // 36 weeks
  const GA_36 = toHourly([
    [0.0, 13.7,13.9,14.0,14.1,14.3,14.4,14.5,14.7,14.8,14.9,15.1,15.2,15.3,15.4,15.6,15.7,15.8,15.9,16.1,16.2,16.3,16.4,16.5],
    [16.6,16.8,16.9,17.0,17.1,17.2,17.3,17.4,17.5,17.6,17.7,17.8,17.9,18.0,18.1,18.2,18.3,18.4,18.5,18.6,18.7,18.8,18.9,19.0],
    [19.1,19.2,19.2,19.3,19.4,19.5,19.6,19.7,19.7,19.8,19.9,20.0,20.1,20.1,20.2,20.3,20.3,20.4,20.5,20.6,20.6,20.7,20.8,20.8],
    [20.9,20.9,21.0,21.1,21.1,21.2,21.2,21.3,21.4,21.4,21.5,21.5,21.6,21.6,21.7,21.7,21.8,21.8,21.9,21.9,22.0,22.0,22.0,22.1],
    [22.1,22.1,22.1,22.1,22.1,22.1,22.1,22.1,22.1,22.1,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.3,22.3],
    [22.3,22.3,22.3,22.3,22.3,22.3,22.3,22.3,22.3,22.3,22.3,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4],
    [22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.6,22.6,22.6,22.6,22.6,22.6,22.6,22.6,22.6,22.6],
    [22.6,22.6,22.6,22.6,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.8,22.8,22.8,22.8,22.8],
    [22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.9,22.9,22.9,22.9,22.9,22.9,22.9,22.9,22.9,22.9,22.9,22.9,22.9],
    [22.9,22.9,22.9,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.0,23.1,23.1,23.1],
    [23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.1,23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.2],
    [23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.2,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3],
    [23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.3,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4],
    [23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.4,23.5,23.5,23.5,23.5,23.5,23.5,23.5,23.5,23.5,23.5,23.5,23.5,23.5,23.5],
    Array(24).fill(23.5)
  ]);

  // 35 weeks
  const GA_35 = toHourly([
    [0.0, 13.1,13.3,13.4,13.6,13.7,13.8,14.0,14.1,14.3,14.4,14.5,14.6,14.8,14.9,15.0,15.1,15.3,15.4,15.5,15.6,15.8,15.9,16.0],
    [16.1,16.2,16.3,16.4,16.5,16.6,16.8,16.9,17.0,17.1,17.2,17.3,17.4,17.5,17.6,17.7,17.7,17.8,17.9,18.0,18.1,18.2,18.3,18.4],
    [18.5,18.5,18.6,18.7,18.8,18.9,18.9,19.0,19.1,19.2,19.2,19.3,19.4,19.4,19.5,19.6,19.6,19.7,19.8,19.8,19.9,19.9,20.0,20.1],
    [20.1,20.2,20.2,20.3,20.3,20.4,20.4,20.5,20.5,20.6,20.6,20.6,20.7,20.7,20.8,20.8,20.8,20.9,20.9,20.9,21.0,21.0,21.0,21.1],
    [21.1,21.1,21.1,21.1,21.1,21.1,21.1,21.1,21.1,21.2,21.2,21.2,21.2,21.2,21.2,21.2,21.2,21.2,21.2,21.3,21.3,21.3,21.3,21.3],
    [21.3,21.3,21.3,21.3,21.3,21.4,21.4,21.4,21.4,21.4,21.4,21.4,21.4,21.4,21.4,21.4,21.5,21.5,21.5,21.5,21.5,21.5,21.5,21.5],
    [21.5,21.5,21.5,21.6,21.6,21.6,21.6,21.6,21.6,21.6,21.6,21.6,21.6,21.6,21.7,21.7,21.7,21.7,21.7,21.7,21.7,21.7,21.7,21.7],
    [21.7,21.8,21.8,21.8,21.8,21.8,21.8,21.8,21.8,21.8,21.8,21.8,21.8,21.9,21.9,21.9,21.9,21.9,21.9,21.9,21.9,21.9,21.9,21.9],
    [21.9,22.0,22.0,22.0,22.0,22.0,22.0,22.0,22.0,22.0,22.0,22.0,22.0,22.0,22.1,22.1,22.1,22.1,22.1,22.1,22.1,22.1,22.1,22.1],
    [22.1,22.1,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.2,22.3,22.3,22.3,22.3,22.3,22.3,22.3,22.3],
    [22.3,22.3,22.3,22.3,22.3,22.3,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.4,22.5,22.5,22.5,22.5],
    [22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.5,22.6,22.6,22.6,22.6,22.6,22.6,22.6,22.6,22.6,22.6,22.6,22.6,22.6],
    [22.6,22.6,22.6,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.7,22.8,22.8,22.8,22.8],
    [22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.8,22.9,22.9,22.9,22.9,22.9,22.9,22.9,22.9,22.9,22.9,22.9],
    Array(24).fill(22.9)
  ]);

  const tables = { 35: GA_35, 36: GA_36, 37: GA_37, 38: GA_38P, 39: GA_38P, 40: GA_38P };

  function getExchangeAt(ga, hours){
    const arr = tables[ga] || tables[38];
    if(hours <= 0) return arr[0].y;
    if(hours >= arr[arr.length-1].x) return arr[arr.length-1].y;
    // linear interpolation on 1-hour grid
    for(let i=1;i<arr.length;i++){
      const p0 = arr[i-1], p1 = arr[i];
      if(hours <= p1.x){
        const t = (hours - p0.x) / (p1.x - p0.x);
        return p0.y + t*(p1.y - p0.y);
      }
    }
    return arr[arr.length-1].y;
  }

  // Exact table value at the completed hour: if age is an exact integer > 0,
  // use the previous hour (e.g., 5.0h -> hour 4), else floor(age).
  function getExchangeExact(ga, hours){
    const arr = tables[ga] || tables[38];
    const age = Math.max(0, hours||0);
    let h = Math.floor(age);
    if(Number.isFinite(age) && Number.isInteger(age) && age > 0){
      h = age - 1;
    }
    h = Math.max(0, Math.min(arr.length - 1, h));
    const p = arr[h];
    return { hour: p.x, value: p.y };
  }

  global.AAP_AnyRisk_Exchange = { tables, getExchangeAt, getExchangeExact };
})(window);
